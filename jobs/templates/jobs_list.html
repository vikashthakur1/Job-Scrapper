<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Job Listings • SkillCaptain</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#111218; --muted:#9aa4b2; --text:#e8eaee; --primary:#6ea8fe; --border:#1c1f28; --accent:#22c55e;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f8fafc; --panel:#ffffff; --muted:#667085; --text:#0f172a; --primary:#2563eb; --border:#e5e7eb; --accent:#16a34a; }
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
    .toolbar{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;padding:14px;border-bottom:1px solid var(--border)}
    .toolbar input,.toolbar select{width:100%;padding:10px 12px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:10px;outline:none}
    .toolbar input::placeholder{color:var(--muted)}
    .btn{padding:10px 14px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:transparent;color:#fff}
    .btn.link{border:none;padding:0;background:none;color:var(--primary);cursor:pointer}

    .stats{display:flex;justify-content:space-between;gap:8px;padding:10px 14px;color:var(--muted);font-size:12px;border-bottom:1px solid var(--border)}
    .list{padding:6px 10px}
    .item{padding:14px;border-radius:12px;border:1px solid transparent;display:grid;grid-template-columns:1fr auto;gap:8px;transition:.15s}
    .item:hover{background:rgba(148,163,184,.06);border-color:var(--border)}
    .title{font-weight:600}
    .meta{color:var(--muted);font-size:12px;margin-top:4px;display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:11px}
    .ext{align-self:center}
    .ext a{color:#fff;text-decoration:none}
    .ext .open{background:var(--primary);border:none;border-radius:10px;padding:8px 10px}
    .empty{padding:28px;text-align:center;color:var(--muted)}
    .footer{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-top:1px solid var(--border)}
    .pager{display:flex;gap:8px}
    .pager .btn{min-width:90px}
    .csv{color:var(--primary);text-decoration:none}
    @media (max-width:720px){ .toolbar{grid-template-columns:1fr 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>SkillCaptain • Job Listings</h1>
          <div class="sub">Live scraped roles. Search, filter, and export.</div>
        </div>
      </div>
      <a id="csvTop" class="btn" href="#">Download CSV</a>
    </header>

    <section class="card" role="region" aria-label="Jobs">
      <form id="filters" class="toolbar" role="search">
        <input name="q" placeholder="Search title or company" autocomplete="off" />
        <input name="location" placeholder="Location (e.g., Remote, India)" autocomplete="off" />
        <select name="source" aria-label="Source">
          <option value="">Any source</option>
          <option value="remoteok">remoteok</option>
        </select>
        <button class="btn primary" type="submit">Search</button>
      </form>

      <div class="stats">
        <div><span id="count">0</span> results</div>
        <div id="activeFilters"></div>
      </div>

      <div id="list" class="list">
        <div class="empty">Loading jobs…</div>
      </div>

      <div class="footer">
        <div class="pager">
          <button id="prev" class="btn" type="button" disabled>← Prev</button>
          <button id="next" class="btn" type="button" disabled>Next →</button>
        </div>
        <a id="csvBottom" class="csv" href="#">Download current view as CSV</a>
      </div>
    </section>
  </div>

  <script>
    const list = document.getElementById('list');
    const form = document.getElementById('filters');
    const countEl = document.getElementById('count');
    const csvTop = document.getElementById('csvTop');
    const csvBottom = document.getElementById('csvBottom');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const activeFilters = document.getElementById('activeFilters');

    const state = { page: 1, page_size: 10, q:'', location:'', source:'' };

    function qs(obj){ return new URLSearchParams(obj).toString(); }
    function setCSVLinks(params){ const u='/api/jobs.csv?'+qs(params); csvTop.href=u; csvBottom.href=u; }
    function chips(params){
      const parts=[];
      if(params.q) parts.push(`<span class="chip">q: ${escapeHtml(params.q)}</span>`);
      if(params.location) parts.push(`<span class="chip">location: ${escapeHtml(params.location)}</span>`);
      if(params.source) parts.push(`<span class="chip">source: ${escapeHtml(params.source)}</span>`);
      activeFilters.innerHTML = parts.join(' ');
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

    async function load(params){
      list.innerHTML = `<div class="empty">Loading jobs…</div>`;
      setCSVLinks(params); chips(params);
      const res = await fetch('/api/jobs/?'+qs(params));
      if(!res.ok){ list.innerHTML = `<div class="empty">Failed to load jobs.</div>`; return; }
      const data = await res.json();
      countEl.textContent = data.count ?? 0;

      const items = (data.results||[]).map(j => `
        <article class="item">
          <div>
            <div class="title"><a href="${j.link}" target="_blank" rel="noopener">${escapeHtml(j.title || '')}</a></div>
            <div class="meta">
              <span>${escapeHtml(j.company || '')}</span>
              ${j.location ? `<span>• ${escapeHtml(j.location)}</span>` : ''}
              ${j.source ? `<span class="chip">${escapeHtml(j.source)}</span>` : ''}
              ${j.created_at ? `<span>• ${new Date(j.created_at).toLocaleString()}</span>` : ''}
            </div>
          </div>
          <div class="ext">
            <a class="open" href="${j.link}" target="_blank" rel="noopener">Open</a>
          </div>
        </article>
      `).join('');

      list.innerHTML = items || `<div class="empty">No results. Try a broader search.</div>`;
      prevBtn.disabled = (params.page||1) <= 1;
      nextBtn.disabled = (data.pages||1) <= (params.page||1);
      prevBtn.onclick = () => { state.page = Math.max(1,(state.page||1)-1); load(state); };
      nextBtn.onclick = () => { state.page = (state.page||1)+1; load(state); };
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const f = new FormData(form);
      state.q = (f.get('q')||'').trim();
      state.location = (f.get('location')||'').trim();
      state.source = (f.get('source')||'').trim();
      state.page = 1;
      load(state);
    });

    const url = new URL(location.href);
    state.q = url.searchParams.get('q') || '';
    state.location = url.searchParams.get('location') || '';
    state.source = url.searchParams.get('source') || '';
    document.querySelector('[name="q"]').value = state.q;
    document.querySelector('[name="location"]').value = state.location;
    document.querySelector('[name="source"]').value = state.source || '';
    load(state);
  </script>
</body>
</html>